# PIO I2S Output Driver for Raspberry Pi Pico

An I2S driver for Raspberry Pi Pico devices.

This project was jointly developed by the [Kinetic Light](https://kineticlight.org) dance company and [Lichen Community Systems](https://lichen.coop). It is maintained by [Colin Clark](https://colinclark.org).

PioI2S is licensed under the BSD-3 License.

## Current Limitations
This is an early stage project and is still under development. It has only been tested with the MAX98357A DAC. It currently has the following limitations:
* Output only
* Does not output SCLK, so it will only work with DACs that include a PLL
* Only supports 32-bit samples

## Including PioI2S in Your Project
PioI2S is a single header library. Just copy ```src/pio-i2s.h``` to your project (or refer to this repository as a submodule) and #include it in your source.

## Building PioI2S
Building PioI2S is only required if you are contributing to the project and need to test and debug it.

## Getting Started
### Prerequisites
1. Git
2. CMake
3. Docker and/or the Pi Pico SDK toolchain

### Update Submodules
Init and recursively update all submodules:
```git submodule update --init --recursive```

### Set Environment Variables
The following environment variables need to be set:
1. ```PICO_OPENOCD_PATH``` should point to a directory containing an RP2350-compatible version of OpenOCD (which should contain both the openocd binary and its scripts directory).
2.  ```PICO_TOOLCHAIN_PATH``` should point to a directory containing the arm-eabi-none GCC cross-compiler.

#### Example Environment Variables
```sh
PICO_TOOLS_PATH=~/.pico-sdk
export PICO_TOOLCHAIN_PATH=$PICO_TOOLS_PATH/toolchain/13_3_Rel1
export PICO_OPENOCD_PATH=$PICO_TOOLS_PATH/openocd/0.12.0+dev
```

## Configuring

#### Configuring the Processor and Board

The project is configured to compile binaries for the Pi Pico 2 W. If you need to change this, override the ```PICO_PLATFORM``` and ```PICO_BOARD``` variables in the CMake build file.

```CMake
set(NAME blinky)
set(PICO_PLATFORM rp2350)
set(PICO_BOARD pico2_w)
```

You can also override these variables when invoking CMake with ```-DPICO_BOARD=<your board>``` and ```-DPICO_BOARD=<your platform>```

#### Release and Debug Builds
The CMake build is set up to build optimized Debug versions by default. To build an unoptimized debug build, include ```-DPICO_DEOPTIMIZED_DEBUG=1``` when you invoke the compile script (or CMake directly). A Release build can be generated by specifying ```-DCMAKE_BUILD_TYPE=Release```.


## Compilation
The firmware can be compiled either in a Docker container or using a locally-installed version of the Pi Pico development toolchain. Flashing the firmware is be done locally using the Pico fork of OpenOCD.

Support for building and remote debugging the firmware in VS Code is also included.

### Compile Locally in the Shell
Assuming the necessary toolchain is installed, a couple of scripts are provided for compiling locally:

#### Compile the Firmware
```sh
./compile.sh
```

#### Clean Up the Build Artifacts
```sh
./clean.sh
```

### Building and Debugging with VS Code
You'll need a Pi Pico Probe connected to your computer, and your Pico board should also be connected via USB. The project is set up with OpenOCD acting as a debug server for arm-eabi-none-gdb running on your computer.

Build tasks have been defined for building unoptimized Debug builds and Release builds.

The CMake extension for VS Code has been set up as well, and can be used to invoke a build from the Command Palette by first choosing "CMake: Configure" and then "CMake: Build". See ```.vscode/settings.json``` for the CMake extension's settings.


### Compile with Docker
The Docker image contains the Pi Pico cross-compilation toolchain pre-installed, so you don't need to have it installed locally (unless you want use a debugger). It assumes you will bind mount the project directory as a volume in the Docker container.

#### Build the Docker Image
```sh
docker build . -t pio-i2s
```

#### Compile the Firwmware
```sh
docker run -v `pwd`:/project --rm pio-i2s ./docker-compile.sh
```

#### Run an interactive shell in the container
```sh
docker run -v `pwd`:/project -it --rm pio-i2s
```

### Caveats
The Docker and local builds share the same CMake build directory, but aren't compatible. Make sure to clean before switching between them.

## License
This repository is released under the BSD-3 license.
